<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>设备维护</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
	</head>

	<link href="../../css/bootstrap.min.css?v=3.3.5" rel="stylesheet">
	<link href="../../css/font/fontawesome.min.css" rel="stylesheet">
	<link href="../../css/font/brands.css" rel="stylesheet">
	<link href="../../css/font/solid.css" rel="stylesheet">
	<link href="../../css/animate.min.css" rel="stylesheet">
	<link href="../../css/style.min.css?v=4.0.0" rel="stylesheet">

	<!--<link rel="stylesheet" type="text/css" href="../../css/appointment.css"/>-->

	<style>
		.appointment-ul2 {
			text-align: right;
			margin-top: 20px;
		}
		
		.appointment-ul2 li {
			margin: 10px 0;
			display: flex;
			/*justify-content: center;*/
		}
		
		.newin {
			height: 33px;
			width: 200px;
		}
		
		.onebtn {
			background-color: #018eea;
			color: #FFFFFF;
			width: 100px;
			height: 40px;
			font-size: 14px;
		}
		
		.towbtn {
			width: 100px;
			height: 40px;
			font-size: 14px;
		}
		
		#ulist_div {
			text-align: left;
		}
		
		.appointment-ul2>li>span {
			width: 80px;
		}
		
		.f_div {
			margin: 5px;
			/*width: 50%;*/
			display: flex;
		}
		
		.f_lab {
			width: 80px;
			text-align: left;
			white-space: nowrap;
			line-height: 34px;
		}
		
		.f_div_fj1 {
			display: flex;
		}
		
		.ml5 {
			margin-left: 5px;
		}
		
		.m5 {
			margin: 5px;
		}
		
		.ulist_div {
			display: flex;
			width: 85%;
			margin: 0 auto;
			border: 1px solid lightgray;
			flex-wrap: wrap;
			padding: 5px;
		}
		
		.ld {
			width: 24%;
			padding: 5px;
			display: flex;
		}
		
		.ld label {
			margin-bottom: 0;
		}
		
		.ld input[type=checkbox],
		input[type=radio] {
			margin-top: 0;
		}
		
		.fileBox {
			width: 100px;
			height: 100px;
			border: 2px dashed #999;
			border-radius: 6px;
			text-align: center;
			line-height: 116px;
			position: relative;
		}
		
		.fileBox .fas.fa-plus:before {
			font-size: 40px;
		}
		
		#equipmentFile {
			position: absolute;
			top: -1px;
			left: 0;
			height: 100px;
			opacity: 0;
		}
		
		.tpl {
			display: none !important;
		}
		
		.checkBox {
			display: flex;
			margin-right: 25px;
			vertical-align: -3px;
		}
		
		.check_out_box {
			max-height: 230px;
			overflow-y: scroll;
			border: 1px solid #999;
			padding-left: 10px;
		}
	</style>

	<body>

		<div class="box">
			<form id="equipmentForm" onsubmit="return false;">

				<ul class="appointment-ul2 ">
					<li>
						<div class="f_div">
							<label class="f_lab"><span style="color: red;">*</span>检查项目：</label>
							<input type="text" class="newin" id="equipmentType" name="inspectProject" value="" />
						</div>
					</li>
					<li>
						<div class="f_div">
							<label class="f_lab"><span style="color: red;">*</span>检查部位：</label>
							<!-- <input type="checkbox" class="" id="equipmentBrand1" name="checkpoint" value=""/>
					<span>胳膊</span>
					<label class="f_lab">胳膊</label>
			        <input type="checkbox" class="" id="equipmentBrand2" name="checkpoint" value=""/>
					<span>腿</span> -->
							<div class="check_out_box oWrapper">
								<div class="tpl checkBox" id="ulist_div">
									<!-- <input type="checkbox" style="margin-top: 10px;" class="checkpoint" id="" name="equipmentPerDO" value=""/> -->
									<!--<input type="checkbox" style="margin-top: 10px;" class="checkpoint" id="" name="projectPos" value=""/>-->
									<label class="f_lab" style="width: 1%;"></label>
									<!--<input type="hidden" class="configInfoString" value="" />-->
								</div>
							</div>
						</div>
					</li>
					<li>
						<!--<div class="f_div">
                    <label class="f_lab"><span style="color: red;">*</span>医院：</label>
                    <span class="hospital"></span>
                    <input type="hidden" id="hospitalId" class="" value=""  />
                </div>-->
						<div class="f_div">
							<label class="f_lab"><span style="color: red;">*</span>医院：</label>
							<select id="applyHos" name="applyHos" class="form-control required" style="width:200px;border-color: #999;">
							</select>
						</div>
					</li>
					<li>
						<div class="f_div">
							<label class="f_lab"><span style="color: red;">*</span>基础价格：</label>
							<input type="number" class="newin" id="equipmentPrice" name="projectPrice" value="" />
						</div>
					</li>
					<input type="hidden" id="createName" class="" value="" />
					<input type="hidden" id="id" class="" value="" />
				</ul>
				<!-- <div id="ulist_div" class="ulist_div">
           <div class="m5 ld"><input type="checkbox"> <label>15669851456 王桂兰</label></div>
            <div class=" ld"><input type="checkbox"> <label>15669851456 王桂兰</label></div>
            <div class=" ld"><input type="checkbox"> <label>15669851456 王桂兰</label></div>
        </div> -->
				<!-- <input type="hidden" id="equipmentUserId" name="equipmentUserId" value=""/> -->

				<div style="text-align: center;margin-top: 30px;" id="query">
					<button class="towbtn" id="saveCancle">取消</button>
					<button class="onebtn" id="saveOk" onclick="saveEquipment()">保存</button>
				</div>
				<div style="text-align: center;margin-top: 30px;display:none;" id="query1">
					<button class="towbtn" id="saveCancle1">取消</button>
					<button class="onebtn" id="saveOk1" onclick="saveEquipment1()">保存</button>
				</div>
				<div style="text-align: center;margin-top: 30px;display:none" id="closeBox">
					<button class="towbtn" id="closeBtn">关闭</button>
				</div>
			</form>

		</div>

	</body>

	<script src="../../js/jquery.min.js?v=2.1.4"></script>
	<script src="../../js/bootstrap.min.js?v=3.3.5"></script>
	<script src="../../js/content.min.js?v=1.0.0"></script>
	<script src="../../js/plugins/suggest/bootstrap-suggest.min.js"></script>
	<script src="../../js/common.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/config.js" type="text/javascript" charset="utf-8"></script>

	<script>
		var imgUrL;
		var userId=sessionStorage.getItem('userId');
		function checkpointInit() {
			ajaxGet('/sys/configType/list', {
				name: "检查部位"
			}, function(resData) {
				//			var data = resData.resultMap.conInfo;
				var data = resData.resultMap.configTypeList;
				checkpointData(data);
				//edit所用  必须放在这，不然组织还没渲染
				if(edit_eqt_index != "") {
					editInit(edit_eqt_index, edit_eqt_name);
				}
				//			else if (edit_eqt_index!="") {
				//				editInit(edit_eqt_index, edit_eqt_name);
				//			}
			});
		}
		//渲染检查部位数据
		function checkpointData(rm) {
			//获取dom插入盒子
			console.log(rm, "123asdad");
			var oWrapper = $(".oWrapper");
			rm.forEach(function(ele, index) {
				//获取克隆dom
				var oCloneDom = $(".tpl").clone().removeClass("tpl");
				//			oCloneDom.css({
				//				"display":"flex",
				//				"margin-right": "20px",
				//				"vertical-align": "-3px"
				//			})
				oCloneDom.addClass("checkBox");
				oCloneDom.find(".f_lab").text(ele.name + "(");
				var configInfoStringArr = ele.configInfoString.split(";");
				for(var i = 0; i < configInfoStringArr.length; i++) {
					//				console.log(configInfoStringArr[i]);
					if(configInfoStringArr[i] == "") {
						continue;
					} else {
						if(configInfoStringArr.length == i + 2) {
							oCloneDom.find(".f_lab").append("<input type='checkbox' style='vertical-align: -2px;margin-left: 5px;' class='checkpoint' id='' name='projectPos' value='" + configInfoStringArr[i] + "'/>" + configInfoStringArr[i] + ")").css({
								"margin-left": "5px"
							});
						} else {
							oCloneDom.find(".f_lab").append("<input type='checkbox' style='vertical-align: -2px;margin-left: 5px' class='checkpoint' id='' name='projectPos' value='" + configInfoStringArr[i] + "'/>" + configInfoStringArr[i]).css({
								"margin-left": "5px"
							});
						}
					}

				}
				oCloneDom.find(".configInfoString").val(ele.configInfoString);
				//数据插入
				oWrapper.append(oCloneDom);
			})
		}

		var ulist;
		var user = JSON.parse(sessionStorage.getItem("user"));
		$(function() {
			$(".hospital").text(user.deptName).css({
				"margin-top": "9px"
			});
			//		if (user.fkHospitalId == null) {
			//			user.fkHospitalId = "无";
			//		}
			$("#hospitalId").val(user.fkHospitalId);
			$("#createName").val(user.userName);
			//医院下拉框 初始化
			// applyreadHospitalBooking();
			//搜索框自动补全
			//		suggestStock();
			//获取渲染组织下拉框
			//selectDept();
			//渲染检查部位数据(多选)
			checkpointInit();
			//		$("#saveOk").click(function(){
			//			saveEquipment();
			//		})
		});
		//编辑赋值初始化，放在下拉框初始化ajax里了
		function editInit(index, statusName) {
			//      var eqt=equipmentList[index];

			if(statusName == "查看") {
				disOninit();
			} else {
				disOninit1();
			}
			var eqt = equipmentList[index];
			console.log(eqt, "asdada");
			$('#equipmentType').val(eqt.inspectProject);
			$(".hospital").text(eqt.hospital).css({
				"margin-top": "9px"
			});
			applyreadHospitalBooking(eqt.hospitalId);
			$("#id").val(eqt.id);
			$("#equipmentPrice").val(eqt.projectPrice);
			var eqtList;
			if(eqt.projectPos.indexOf(",") != -1) {
				eqtList = eqt.projectPos.split(",");
				//			console.log(eqtList,"asdasdadas");
				for(var i = 0; i < eqtList.length; i++) {
					$("input[name='projectPos'][value='" + eqtList[i] + "']").attr("checked", "checked");
				}
			} else {
				eqtList = eqt.projectPos;
				//			console.log(eqtList,"asdad");
				$("input[name='projectPos'][value='" + eqtList + "']").attr("checked", "checked");
			}

		}

		function selectDept() {
			//获取组织列表
			ajaxGet('/sys/user/list', {}, function(res) {
				ulist = res.resultMap.userList;

				var newList = [];
				for(var k in ulist) {
					//组织名
					var id = ulist[k].fkDeptId == null ? ulist[k].fkHospitalId : ulist[k].fkDeptId;
					var newName = ulist[k].deptName == null ? ulist[k].hospitalName : ulist[k].deptName;
					if(newList.indexOf(newName) < 0) {
						newList.push(newName);
						$('#permissions').append('<option value="' + id + '">' + newName + '</option>');
					}
				}
				//主动调用一次选中事件
				selectChange();

				//edit所用  必须放在这，不然组织还没渲染
				if(edit_eqt_index != "") {
					editInit(edit_eqt_index);
				}
			})
		}

		//查看时 禁用初始化
		function disOninit() {
			$("#applyHos").attr("disabled", "disabled");
			$("#applyDepartment").attr("disabled", "disabled");
			$("#equipmentType").attr("disabled", "disabled");
			$("#equipmentName").attr("disabled", "disabled");
			$("#equipmentBrand").attr("disabled", "disabled");
			$("#equipmentModel").attr("disabled", "disabled");
			$(".checkpoint").attr("disabled", "disabled");
			$("#equipmentPrice").attr("disabled", "disabled");
			$("#equipmentFile").attr("disabled", "disabled");
			$("#query").hide();
			$("#query1").hide();
			$("#closeBox").show();
		}

		function disOninit1() {
			$("#query1").show();
			$("#query").hide();
			$("#closeBox").hide();
		}
		//搜索框自动补全
		function suggestStock() {
			ajaxGet('/oa/patinfo/list', {}, function(res) {
				var resdata = res.resultMap.patinfoList;

				var baiduBsSuggest = $("#equipmentUserName").bsSuggest({
					//indexId: 0,//每组数据的第几个数据，作为输入输入框的数据id
					//indexKey: 1,//每组数据的第几个数据，作为输入输入框的内容
					idField: 'id', //每组数据的哪个字段作为 data-id，优先级高于 indexId 设置（推荐）
					keyField: 'name', //每组数据的哪个字段作为输入框内容，优先级高于 indexKey 设置（推荐）
					allowNoKeyword: false, //是否允许无关键字时请求数据
					showHeader: true, //是否显示选择列表的 header，默认有效字段大于一列时显示，否则不显示
					showBtn: true, //是否显示下拉按钮
					listAlign: "auto", //提示列表对齐位置，left/right/auto
					listStyle: {
						"max-width": "200px",
						"width": "100%"
					},
					effectiveFields: ["name", "idCode"], //有效显示于列表中的字段，非有效字段都会过滤
					effectiveFieldsAlias: { //有效字段的别名
						name: "姓名",
						idCode: "身份证号"
					},
					data: {
						"value": resdata
					}
				}).on("onSetSelectValue", function(a, b) { //选择商品后触发
					$("#equipmentUserId").val(b.id);
				});
			})
		}
		//save前 非空验证
		function fromIsNull(fromArray) {
			var flag = false;
			var c = 0;

			console.log(fromArray);
			$.each(fromArray, function(i, item) {
//				console.log(item['value'] == '')
				if(item['value'] == '') {
					flag = true;
					return false;
				}
				// if (item['name'] == "equipmentPerDO") {
				//     c++;				
				// }
//				console.log(item['name'] == "projectPos")
				if(item['name'] == "projectPos") {
					c++;
				}
			});
//			console.log(flag);
//			console.log(c)
			if(flag || c == 0) {
				alert('信息不可为空');
				return true;
			}
			return false;
		}
		//保存
		// var fromData = {};
		function saveEquipment() {
			//上传头像函数执行
			// uploadImg();
			//判断表单数据是否为空
			var fromArray = $('#equipmentForm').serializeArray();
			console.log(fromArray, "asdasd");
			// alert($("#applyHos").val());
			//非空验证
		    if(fromIsNull(fromArray)){
		        return;
		    }
			var fromData = {};
			$.each(fromArray, function() {
				if(this.name == "projectPos") {
					var uv = fromData["projectPos"] == null ? this.value : fromData["projectPos"] + "," + this.value;
					fromData["projectPos"] = uv;
				} else {
					fromData[this.name] = this.value;
				}
			});
			//		fromData.equipmentUrl = imgUrL;
			fromData.hospitalId = $("#applyHos").val();
			fromData.createName = $("#createName").val();
			fromData.hospital = $('#applyHos option:selected').text();
			console.log(fromData);
			url = '/inspect/project/save';
			ajaxGet(url, fromData, function(res) {
				alert(res.message);
				if(res.status == 1) {
					location.reload();
				}
			})
		}

		function saveEquipment1() {
			//上传头像函数执行
			// uploadImg();
			//判断表单数据是否为空
			var fromArray = $('#equipmentForm').serializeArray();
			console.log(fromArray, "asdasd");
			// alert($("#applyHos").val());
			//非空验证
		    if(fromIsNull(fromArray)){
		        return;
		    }
			var fromData = {};
			$.each(fromArray, function() {
				if(this.name == "projectPos") {
					var uv = fromData["projectPos"] == null ? this.value : fromData["projectPos"] + "," + this.value;
					fromData["projectPos"] = uv;
				} else {
					console.log(this.value);
					fromData[this.name] = this.value;
				}
			});
			//		fromData.equipmentUrl = imgUrL;
			fromData.hospitalId = $("#hospitalId").val();
			fromData.createName = $("#createName").val();
			fromData.hospital = $(".hospital").text();
			fromData.id = $("#id").val();
			console.log(fromData);
			url = '/inspect/project/update';
			ajaxGet(url, fromData, function(res) {
				alert(res.message);
				if(res.status == 1) {
					location.reload();
				}
			})
		}

		//点击导入的新增信息 的取消
		$("#saveCancle").click(function() {
			$("#subscribeListLight1").css("display", "none");
			$("#subscribeListFade").css("display", "none");
		});
		$("#saveCancle1").click(function() {
			$("#subscribeListLight1").css("display", "none");
			$("#subscribeListFade").css("display", "none");
		});
		//点击查看的信息的关闭
		$("#closeBtn").click(function() {
			$("#subscribeListLight1").css("display", "none");
			$("#subscribeListFade").css("display", "none");
		});

		//		医院信息渲染
		applyreadHospitalBooking();
		//指定医院下拉框 初始化
		function applyreadHospitalBooking(hosId) {
			$("#applyHos").html('');
			$.ajax({
				type: "get",
				url: config + "/sys/hospital/list",
				async: false,
				dataType: "jsonp",
				jsonp: "jsoncallback",
				data: {},
				success: function(data) {
					console.log(data);
					if(data.status == 1) {
						var hospitalList = data.resultMap.hospitalList;
						if(hospitalList != null) {
							for(var s = 0; s < hospitalList.length; s++) {
								var hospitalHtml = '';
								hospitalHtml += '<option value="' + hospitalList[s].id + '">' + hospitalList[s].name + '</option>';
								$("#applyHos").append(hospitalHtml);
							}
						}
					}
					if(userId != 1) {
						$("#applyHos").val(user.deptId);
						$("#applyHos").attr("disabled", "disabled");
					}
					if(hosId!=''&&hosId!=null&&hosId!=undefined){
						if(userId != 1) {
							$("#applyHos").val(hosId);
							$("#applyHos").attr("disabled", "disabled");
						}else{
							$("#applyHos").val(hosId);
						}
					}
				},
			});
		}
	</script>

</html>
<!---->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <title>远程医疗系统-组织架构</title>
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" href="../../css/organize.css"/>

    <style>

        video {
            width: 100%;
            height: 100%;
        }
        .containDiv_hi {
            width: auto !important;
            height: auto !important;
            display: flex;
        }

        .containDiv_hi > div {
            width: 50%;
            min-height: 500px;
        }

        .containDiv_hi > div:first-child {
            padding: 30px;
            border: 1px solid #EDEDED;
        }

        .videoDiv {
            width: 100%;
            min-height: 450px;
            position: relative;

        }

        .tabDivhome {
            display: flex;
        }

        .tabDiv {
            width: 100px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background-color: whitesmoke;
            cursor: pointer;
        }

        video {
            width: 100%;
            height: 100%;
        }

        #remote-video-wrap {
            position: relative;
            height: 100%;
        }

        .videoLocal {
            position: absolute;
            left: 5px;
            top: 1px;
            z-index: 9;
        }

        .rigthTabDiv {
            border-top: 1px solid #EDEDED;
            /*width: 100%;*/
            min-height: 550px;
            padding: 30px;
            position: relative;
        }

        .tab1 > div {
            width: 90%;
            height: 30px;
            line-height: 30px;
            margin: 15px 0 15px 15px;
            display: flex;
        }

        .tab1 > div > div {
            width: 15%;
            text-align: right;
        }

        .tab1 input {
            border: 1px solid #EDEDED;
            width: 60%;
            padding-left: 15px;
        }

        .tab2 > div {
            width: 90%;
            height: 80px;
            line-height: 80px;
            margin: 15px 0 15px 15px;
            display: flex;
        }

        .tab2 > div > div {
            width: 15%;
            text-align: right;
        }

        .tab2 textarea {
            border: 1px solid #EDEDED;
            width: 80%;
            padding-left: 15px;
        }

        .endBtn {
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 35%;
        }

        .endBtn > input {
            width: 100px;
            height: 35px;
            line-height: 40px;
            background: #008EEA;
            color: #fff;
            border: 0;
        }

        .on {
            line-height: 40px;
            background: #008EEA;
            color: #fff;
        }

        .tab3 {
            width: 100%;
            height: 100%;
        }

        .tab3 > ul {
            padding: 0;
            margin: 0;
        }

        .tab3ul > li {
            border: 1px solid #CAC8C6;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;

        }

        .tab3ul > li > div {
            border-right: 1px solid #CAC8C6;
            min-width: 15%;
            text-align: center;
            min-height: 40px;
            line-height: 40px;
            width: auto;
            display: inline-block !important;
            display: inline;
        }
		.doctorAdvice img{
			width:100%;
			height: 156px;
			margin-right:3.5%;
			/*margin-bottom: 20px;*/
			border: 1px solid #E2E3E3;	
			cursor:pointer;
		}
		.delImgAll{
			width:20%;
			/*height: 156px;*/
			margin-right:3.5%;
			margin-bottom: 20px;
			/*border: 1px solid #E2E3E3;*/	
			cursor:pointer;
		}
		.doctorAdvice{
			height: auto;
			/*display: none;*/
		}
		#J_pg{
			z-index: 88888;
		}
		.tab4{
			display: none;
			max-height: 650px;
			overflow: auto;
		}
		.delImgAll span{
			cursor: pointer;
			font-size: 1.25em;
			background:#1B1B1B;
			opacity: 0.5;
			color: #fff;
			border-bottom-left-radius: 13px;
		}
		.delImgAll span:hover{
			background:#1B1B1B;
			opacity: 0.5;
			color: #fff;
		}
		#patientFadeUpload{
      	width: 100%;
      	height: 100%;
      	background-color: black;
      	display: none;
      	position: absolute; 
        top: 0%; 
        left: 0%; 
        opacity: 0.5;
        color:#fff;
        text-align: center;
      }
      #patientFadeUpload{
      	z-index: 999999!important;
      }
      #audienceFade{
            width: 100%;
            height: 100%;
            background-color: black;
            display: none;
            position: absolute;
            top: 0%;
            left: 0%;
            opacity: 0.5;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="containDiv_hi">
    <div>
        <div class="videoDiv" >
            <img id="audience_back" src="../../img/aucience_back.jpg" alt="" style="position: absolute;left: 0;top: 0;width: 100%;height: 100%">
            <!--视频所需信息-->
            <div style="display: none">
                <input class="form-control" id="sdkappid" type="text" value="1400037025"/>
                <input class="form-control" id="userId" type="text" value=""/>
                <input class="form-control" id="roomid" type="text" value="113355">
                <input class="form-control" id="privmap" type="text" value="">
            </div>
            <!--视频窗-->
            <div id="remote-video-wrap" >

            </div>
        </div>
    </div>
    <div>
        <div class="tabDivhome">
            <div class="tabDiv on" id="tabDiv1">患者信息</div>
            <div class="tabDiv" id="tabDiv2">临床信息</div>
            <div class="tabDiv" id="tabDiv3">诊断建议</div>
            <div class="tabDiv" id="tabDiv4">历史医嘱</div>
        </div>
        <div class="rigthTabDiv">
            <div class="tab1">
                <div>
                    <div>身份证号：</div>
                    <input disabled name="idCode" id="idCode" type="text" value="123">
                </div>
                <div>
                    <div>患者姓名：</div>
                    <input disabled name="bookingName" id="bookingName" type="text" value="王海量1">
                </div>
                <div>
                    <div>性别：</div>
                    <input disabled name="sex" id="sex" type="text" value="男1">
                </div>
                <!--<div>
                    <div>年龄：</div>
                    <input  type="text" value="29">
                </div>-->
                <div>
                    <div>联系电话：</div>
                    <input disabled name="phone" id="phone" type="text" value="13955552116">
                </div>
                <!--<div>
                    <div>入院日期：</div>
                    <input type="text" value="2018-8-8">
                </div>
                <div>
                    <div>就诊类型：</div>
                    <input type="text" value="什么类型">
                </div>-->
                <!--<div>
                    <div>就诊科室：</div>
                    <input name="stature" id="stature" type="text" value="A科室">
                </div>-->

            </div>
            <div class="tab2" style="display: none">
                <div>
                    <div>主诉：</div>
                    <textarea disabled name="subjText" id="subjText"></textarea>
                </div>
                <div>
                    <div>现病史：</div>
                    <textarea disabled name="medicalHistory" id="medicalHistory"></textarea>
                </div>
                <div>
                    <div>既往史：</div>
                    <textarea disabled name="pastHistory" id="pastHistory"></textarea>
                </div>
                <div>
                    <div>过敏史：</div>
                    <textarea disabled name="allergyHistory" id="allergyHistory"></textarea>
                </div>
                <div>
                    <div>家族史：</div>
                    <textarea disabled name="familyHistory" id="familyHistory"></textarea>
                </div>
            </div>
            <div class="tab3" style="display: none">
                <!--<div><input onclick="addDrug()" type="button" value="添加药品"></div>-->
                <div>
                    <div>医师诊断：</div>
                    <textarea style="width: 400px;height: 100px;" name="doctorDiag" id="doctorDiag"></textarea>
                </div>
                <div>
                    <div>治疗建议：</div>
                    <textarea style="width: 400px;height: 100px;" name="doctorSuggest" id="doctorSuggest"></textarea>
                </div>
                <!--自动补全框开始-->
                <!--<div class="input-group " >
                    <input type="text" style=" width: 400px;"  class="form-control" name="stockno" id="stockno">
                    <ul class="dropdown-menu " role="menu"></ul>
                </div>-->
                <!--自动补全框结束-->

                <!--<ul class="tab3ul">-->
                <!--<li>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--</li>-->
                <!--<li>-->
                <!--<div class="searchDivAudience">233</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--<div>1</div>-->
                <!--</li>-->
                <!--</ul>-->
            </div>
            <div class="tab4">
            	<div class="infoDetails-ul showAllInfoUls doctorAdvice gallerys">
                	<!--<img src="../../img/a1.jpg" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)" />
                	<img src="../../img/a3.jpg" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)"  />
                	<img src="../../img/a5.jpg" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)" />
                	<img src="../../img/a8.jpg" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)"  />-->
                	<div class="noHasDocDevice"style="width:100%;text-align: center;">暂无医嘱</div>
            	</div>
            </div>
            <div class="endBtn">
                <input onclick="inviteVideo()" type="button" value="邀请视频">
                <input onclick="saveAdvice()" type="button" value="问诊结束">
                <div style="display: inline-block;position: relative;width:100px;">
                	<input type="file" id="file"name="file" style="width:100px;height:35px;z-index:1;display:inline-block;position:relative;opacity: 0;-moz-opacity: 0;-ms-opacity: 0;-webkit-opacity: 0;cursor: pointer;top:33px;"value="" title=" "/>
                	<input id="uploadDoctorDeviceBtn"type="text" value="上传医嘱"disabled="disabled"style="width:100px;height:30px;position:relative;top:-3px;text-align: center;cursor: pointer;">
                </div>
            </div>
        </div>
    </div>
    <div id="patientFadeUpload"><img src="../../css/plugins/blueimp/img/loading.gif" alt=""style="width:40px;height:40px;position: relative;top:200px;left: 0%;" /><div style="width:100px;height:40px;position: relative;top:166px;left: 51%;">上传中......</div></div>
  	<!--<div id="uploadingImg"style="display: block;height:auto;position:relative;top:20%;left:40%;text-align: center;z-index:9999999!important;"><img src="../../css/plugins/blueimp/img/loading.gif" alt=""style="width:40px;height:40px;" />上传中......</div>-->
	<!--灰背景-->
    <div id="audienceFade" class="black_overlay"><img src="../../css/plugins/blueimp/img/loading.gif" style="width:60px;height;60px;position: relative;top:200px;left: 0%;" /></div>
</div>


<script src="../../js/jquery-3.0.0.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/config.js"></script>
<script src="../../js/commonNew.js"></script>
<!-- jquery Demo用到，WebRTCAPI不依赖 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121844058-1"></script>
<script src="../../js/bootstrap-suggest.min.js"></script>
<!--<script src="../caseInfoControl/jquery-photo-gallery/jquery.js"></script>-->
<script src="../caseInfoControl/jquery-photo-gallery/jquery.photo.gallery.js"></script>
<!--<script src="../../js/WebRTCAPI.min.js"></script>-->
<script src="https://sqimg.qq.com/expert_qq/webrtc/2.6.2/WebRTCAPI.min.js"></script>
<script src="../../js/index.js"></script>

<script>
    var user = JSON.parse(sessionStorage.getItem('user'));
	var sessionId=sessionStorage.getItem('sessionId');
	console.log(user.id);
    function inviteVideo() {


        console.log('audience-user:::', user);

        var applyUserCodeQueuing = sessionStorage.getItem('applyUserCodeQueuing');
        var appointUserCodeQueuing = sessionStorage.getItem('appointUserCodeQueuing');
        var jsonData = {
            'applyUserCode': applyUserCodeQueuing,
            'appointUserCode': appointUserCodeQueuing,
            'roomId': user.id,
            'type': 1,
            'patinfoId': sessionStorage.getItem('queuingFkPatinfoId'),
            'queuingId': sessionStorage.getItem('queuingId')
        };
        //发送websocket消息给 对方，让对方接受视频邀请
        ajaxGet('/oa/interrogationInfo/sendInvite', jsonData, function (res) {
            if (res.status == 1) {
                window.parent.swal({title:res.message+'等待对方接受'});
                push(user.id);
            } else {
                window.parent.swal({title:res.message});
            }
        });
    }
    window.onload=function(){
			$(document).on("click",".delBtn",function(){
				var imgId=$(this).parent().find(".imgId").text();
				var currentLineIds=$(this).parent().parent().find(".hiddenPatientId").text();
//			删除单条历史医嘱
				var mymessage=confirm("您确定要删除此医嘱吗?");
			    if(mymessage==true){   
			    	ajaxGet('/oa/patinfo/removeImage', {
		            	imgId:imgId,
			        }, function (resData) {
			            alert("删除成功！");
			            historyDoctorDevice(sessionStorage.getItem('queuingFkPatinfoId'));
		        });  
			    }
			});
		}
	//			读取患者历史医嘱
	historyDoctorDevice(sessionStorage.getItem('queuingFkPatinfoId'));
	function historyDoctorDevice(currentLineIds){
		ajaxGet('/oa/patinfo/get', {
            	fkPatinfoId:currentLineIds,
	       }, function (resData) {
	            var patinfoImageList=resData.resultMap.patinfoImageList;
	            if(patinfoImageList.length>0){
		            $(".doctorAdvice").html('<span class="hiddenPatientId"style="display:none;">'+currentLineIds+'</span>');
		            for(var i=0;i<patinfoImageList.length;i++){
		            	var dHtml='';
		            	dHtml+='<div style="position:relative;float:left;"class="delImgAll">';
		            	dHtml+='<img src="'+patinfoImageList[i].imgUrl+'" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)" />';
		            	dHtml+='<span style="position:relative;top:-162px;right:-89.5%;text-align:center;display:inline-block;width:16px;height:16px;line-height:16px;"class="delBtn">&times;</span>';
		            	dHtml+='<p style="margin-top:0;">上传者:'+patinfoImageList[i].imgUserName+'</p>';
		            	dHtml+='<p style="margin-bottom:20px;">上传时间:'+patinfoImageList[i].imgTime+'</p>';
		            	dHtml+='<span style="display:none;"class="imgId">'+patinfoImageList[i].imgId+'</span>';
		            	dHtml+='</div>';
//		            	dHtml+='<img src="'+patinfoImageList[i].imgUrl+'" class="gallery-pic"alt="" onclick="$.openPhotoGallery(this)" />'
		            	$(".doctorAdvice").append(dHtml);
		            }
	            }else{
	            	 $(".doctorAdvice").html('<div class="noHasDocDevice"style="width:100%;text-align: center;">暂无医嘱</div>');
	            }
	            
	        });
	}
			
    function saveAdvice() {

        var doctorDiag = $('#doctorDiag').val();
        var doctorSuggest = $('#doctorSuggest').val();
        var jsonData = {
            "doctorDiag": doctorDiag,
            "doctorSuggest": doctorSuggest,
            "fkInterrogationId": sessionStorage.getItem('queuingId'),
        };
		$("#audienceFade").fadeIn();
        ajaxGet('/oa/advice/save', jsonData, function (res) {
            //视频断流
            $("#audienceFade").fadeOut();
            quitRTC();
            location.href = '../queuing/queuingIndex.html';
        });
    }
//		点击上传医嘱		
		$(document).on("click","#file",function(){
//			$("#patientLight").fadeIn();
//			$("#patientFade").fadeIn();
			addPic($(this));
		});
		function addPic(fileId) {
			fileId.off('change').on('change',function() {
//				alert("ccccc");
				$("#patientFadeUpload").css("display","block");
//				$("#uploadingImg").css("display","block");
				var file = this.files[0];
				var fsize = parseInt((file.size)/ 1024); //计算图片大小，默认是B，转换成KB  
				if(!/image\/\w+/.test(file.type)) {
		
					alert("请确保文件为图像类型");
					return false;
				}
//				if(fsize >= 500) {
//					alert("图片过大，请重新选择图片");
//					return false;
//				}
				if(!/\.(jpg|png|JPG|PNG)$/.test(fileId.val())) {
					alert("图片类型必须是.jpg,png中的一种");
					return false;
				}
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function(e) {
//					imgId.attr('src', this.result);
//					if(imgId.attr('id') == 'img0') {
//						$('#big_img img').attr('src', this.result);
//					}
					var fileElementId=$(fileId).attr("id");
					var formData = new FormData();
					formData.append("file", document.getElementById(fileElementId).files[0]); 
					formData.append("fkPatinfoId",sessionStorage.getItem('queuingFkPatinfoId'));
					formData.append("sessionId",sessionId);
					console.info(formData.get("fkPatinfoId"));
//					console.info(formData.get("sessionId"));
//					console.log(document.getElementById(fileElementId).files[0]);
					$.ajax({
			            url:config+'/oa/patinfo/uploadImage',
		//				url:"http://192.168.18.189:8080/gcafu_commerce/rest/upload/product",
			           	type:'POST',
						data:formData,
						async: false,  
          				cache: false, 
						dataType:'JSON', //接收值的格式
						enctype:'multipart/form-data',
						contentType: false,
						processData: false,
						success:function(data){ 
			                //把图片替换  
			                $("#patientFadeUpload").css("display","none");
//							$("#uploadingImg").css("display","none");
							alert("上传成功!");
							$(fileId).val('');
							historyDoctorDevice(sessionStorage.getItem('queuingFkPatinfoId'));
			            },  
			            error: function () {  
			                alert("上传失败！");  
			            }  
			        });  
				}
			});
		}
</script>
<script>
    $(function () {
        getAudiData();
    });
    //页面关闭 断流
    window.onunload=function () {
        //视频断流
        quitRTC();
    };
    //页面值 获取查询
    function getAudiData() {
        ajaxGet('/oa/patinfo/get', {fkPatinfoId: sessionStorage.getItem('queuingFkPatinfoId')}, function (resData) {
            if (resData.resultMap.patinfo != null) {
                setAudienceData(resData.resultMap.patinfo);
            }
        });

    }

    //页面赋值
    function setAudienceData(data) {
        if (sessionStorage.getItem('subjTextQueuing') != null) {
            $('#subjText').val(sessionStorage.getItem('subjTextQueuing'));
        }
        if (data != null) {
            $('#idCode').val(data.idCode);
            $('#bookingName').val(data.name);
            $('#sex').val(data.sex);
            $('#phone').val(data.phone);
            $('#medicalHistory').val(data.medicalHistory);
            $('#pastHistory').val(data.pastHistory);
            $('#allergyHistory').val(data.allergyHistory);
            $('#familyHistory').val(data.familyHistory);
        }

    }
</script>


<script>

    $('#tabDiv1').click(function () {
        $(".tab1").css("display", "block");
        $(".tab2").css("display", "none");//隐藏
        $(".tab3").css("display", "none");//隐藏
        $(".tab4").css("display", "none");//隐藏
        $("#tabDiv1").addClass('on');
        $("#tabDiv2").removeClass('on');
        $("#tabDiv3").removeClass('on');
        $("#tabDiv4").removeClass('on');
    });
    $('#tabDiv2').click(function () {
        $(".tab2").css("display", "block");
        $(".tab1").css("display", "none");//隐藏
        $(".tab3").css("display", "none");//隐藏
         $(".tab4").css("display", "none");//隐藏
        $("#tabDiv2").addClass('on');
        $("#tabDiv1").removeClass('on');
        $("#tabDiv3").removeClass('on');
        $("#tabDiv4").removeClass('on');
    });
    $('#tabDiv3').click(function () {
        $(".tab3").css("display", "block");
        $(".tab2").css("display", "none");//隐藏
        $(".tab1").css("display", "none");//隐藏
         $(".tab4").css("display", "none");//隐藏
        $("#tabDiv3").addClass('on');
        $("#tabDiv2").removeClass('on');
        $("#tabDiv1").removeClass('on');
        $("#tabDiv4").removeClass('on');
    });
    $('#tabDiv4').click(function () {
        $(".tab4").css("display", "block");
        $(".tab2").css("display", "none");//隐藏
        $(".tab1").css("display", "none");//隐藏
         $(".tab3").css("display", "none");//隐藏
        $("#tabDiv4").addClass('on');
        $("#tabDiv3").removeClass('on');
        $("#tabDiv2").removeClass('on');
        $("#tabDiv1").removeClass('on');
    });
</script>


</body>

</html>
<template>
  <div class="editable-cell">
    <div
      v-if="editable"
      class="editable-cell-input-wrapper"
    >
      <a-input
        :value="value"
        placeholder="在此输入信息..."
        @change="handleChange"
        @pressEnter="check"
        ref="firstInput"
      />
      <!--:dataIndex="dataIndex(data, index) => index"-->
      <!--:rowKey="(data, index) => index"-->
     <!-- <a-icon
        type="check"
        class="editable-cell-icon-check"
        @click="check"
      /> -->
    </div>
    <div
      v-else
      class="editable-cell-text-wrapper"
      @click="edit"
    >
      {{ value || ' ' }}
      <!-- <a-icon
        type="edit"
        class="editable-cell-icon"
        @click="edit"
      /> -->
    </div>
  </div>
</template>
<script>
	import $ from 'jquery';
	let keyArr = [];
	let oldData = [];
  // let inframTable = document.querySelector(".inframTable");
export default {
	inject: ["reload"],
  props: {
    text: String,
    biographyKey: Number,
    dataArr: Array,
    pageKeySon: String,
    alertKeySon: String
//  dataIndex1: String
  },
  data () {
    return {
      value: this.text,
      editable: false,
//    dataIndex: this.dataIndex1,
      // placeholder: this.text
      event: null
    };
  },
  methods: {
    handleChange (e) {
//  	console.log(e,"输入框聚焦并输入改变");
//  	console.log(e.target,"输入框聚焦并输入改变");
      const value = e.target.value;
      this.value = value;
      let inframTable = document.querySelector(".inframTable");
      inframTable.style.display = "block";      
      let trArr = $(".inframTable").find("tbody").find("tr");
      for(let i = 0; i < trArr.length; i++){
      	if($(trArr[i]).attr("class").indexOf("active") != -1){
      		$(trArr[i]).removeClass("active");
      	}else{
      		$(trArr[0]).addClass("active");
      		document.dispatchEvent(this.event);
      	}
      }
      let trHeight = e.path[4].clientHeight;
//    console.log("tr的高", trHeight);
      //获取弹出表格的高      
      let iframTableHeight = (inframTable.style.height).split("px")[0];
      iframTableHeight = iframTableHeight - 0;
//    console.log(iframTableHeight);
      //获取弹出表格的top值
      let iframTableTop = (inframTable.style.top).split("px")[0];
      iframTableTop = iframTableTop - 0;
//    console.log(iframTableTop);
      //移动表格
//    console.log(this.biographyKey, "传的Key值")
//			console.log(this.pageKeySon, "传的pageKeySon值")
			switch (this.pageKeySon){
				case "2":
					this.changeTable(104)
					break;
				case "3":
					this.changeTable(62)
					break;
				default:
					this.changeTable(62)
					break;
			}
			inframTable.addEventListener("click", this.myClick);
    },
    check () {
      this.editable = false;
      this.$emit('change', this.value);
      let inframTable = document.querySelector(".inframTable");
      inframTable.style.display = "none";
//			console.log(this.value,"input的value");
			if(this.value == ""){
				this.value = "在此输入信息...";
			}else{
//				console.log(this.biographyKey, "传的Key值")
				keyArr.push(this.biographyKey);
				//初始没有新的一行的添加
				let keyValue = this.dataArr[this.dataArr.length - 1].key;
//				if(keyArr.length == 1){
//					this.$emit('handleAddSon');
//				}else{
//					//如果点击的是数据的最后一项添加
//					if(this.biographyKey == keyValue){
//						this.$emit('handleAddSon');
//					};
//				};
//				if(keyArr.length == 1){
//					this.$emit('handleAddSon');
//				}else{
//					//如果点击的是数据的最后一项添加
//					if(this.biographyKey == keyValue){
//						this.$emit('handleAddSon');
//					};
//				};
//				console.log(this.pageKeySon)
//				console.log(this.alertKeySon)
//				console.log(this.pageKeySon == "3" && this.alertKeySon == "1");
				if (this.pageKeySon == "3" && this.alertKeySon == "1") {
					if(keyArr.length == 1){
						this.$emit('handleAddSon');
					}else if(keyArr.length == 6){
						//如果点击的是数据的最后一项添加
						let t = window.confirm("已经超过允许的处方签药品数量,是否继续?");
						if (t == true) {
							this.$emit('addMenuSon');
							//存数据
							const dataarr = [...this.dataArr];
//							const target = dataarr.find(item => item.key === 5)
        			const target = dataarr.find(item => item.key === this.biographyKey)
        			console.log(target)
							sessionStorage.setItem("dataObj", JSON.stringify(target));
//							this.reload();
							console.log("点击确定增加表格数据");
							let obj = JSON.parse(sessionStorage.getItem("dataObj"));
							console.log("差数据回填");
						} else{
							console.log("点击取消清空表格数据");
						}
					}else{
						if(this.biographyKey == keyValue){
							this.$emit('handleAddSon');
						}
					};
				} else{
					if(keyArr.length == 1){
						this.$emit('handleAddSon');
					}else{
						//如果点击的是数据的最后一项添加
						if(this.biographyKey == keyValue){
							this.$emit('handleAddSon');
						}
					}
				};
//				if (this.pageKeySon == "2") {
//					if(keyArr.length == 1){
//						this.$emit('handleAddSon');
//					}else{
//						//如果点击的是数据的最后一项添加
//						if(this.biographyKey == keyValue){
//							this.$emit('handleAddSon');
//						};
//					};
//				}else if(this.pageKeySon == "3"){
//					if(keyArr.length == 1){
//						this.$emit('handleAddSon');
//					}else if(keyArr.length == 4){
//						//如果点击的是数据的最后一项添加
//						console.log("已经第五个了!!!!!!")
//					}else{
//						if(this.biographyKey == keyValue){
//							this.$emit('handleAddSon');
//						};
//					};
//				}
//					console.log(this.biographyKey, "传的Key值")
//					if (this.alertKeySon == "1" && this.biographyKey == 5) {
//						let t = window.confirm("已经超过允许的处方签药品数量,是否继续?");
//						if (t == true) {
//							this.$emit('addMenuSon');
//							//存数据
//							sessionStorage.setItem("name", x);
//							console.log("点击确定增加表格数据")
//						} else{
//							console.log("点击取消清空表格数据")
//						}
//					}
			};
			//获取所有兄弟集合
			let brotherAggregate = this.$parent.$parent.$children;
			//找到目标元素
			let targetNode = brotherAggregate[2].$children[0];	
			//赋值聚焦
			let targetValue = targetNode.$el;
			targetValue.value = "1";
			targetNode.focus();
//    console.log(targetNode, "获得input元素的下一个元素");
      //获取表格的tr
      let trArr = $(".inframTable").find("tbody").find("tr");
      //获取内层选中数据
      let dataObj = trArr.map( (index, item) => {
      	let dataobj = {};
      	if ($(item).attr("class").indexOf("active") != -1) {
      		let tdArr = $(item).children();
      		dataobj = tdArr.map( (index, item) => {
      			return dataobj[index] = $(item).text()
      		});
      	};
				return dataobj;
      });
      //处理空数据
//    dataObj = dataObj.filter( (index, item) => {
//    	return Object.keys(item).length !== 0
//    });
      dataObj = dataObj.filter( (index, item) => Object.keys(item).length !== 0 )
      //改变外层数据值
//    let dataarr = [...this.dataPriceArr];
      const dataarr = [...this.dataArr];
//	  	console.log(dataarr,"dataarr")
	  	const target = dataarr.find(item => item.key === this.biographyKey) 
//	  	const target = dataarr.find(item => item.key === 0)    	
	  	
	  	if (this.pageKeySon == "3" && this.alertKeySon == "1") {
	  		if (this.biographyKey == 5) {
	  			target.address = "";
	  			target.age = "";
	  			target.allprice = "";
	  			target.company = "";
	  			target.day = "";
	  			target.name = "在此输入信息...";
	  			target.key = 5;
	  			target.openingdoctor = "";
	  			target.openingtime = "";
	  			target.price = "";
	  			target.wrong = "";
	  			this.value = target.name;
	  			targetValue.value = "";
	  			targetNode.focus();
	  		} else{
	  			target.price = dataObj[0][2];
			  	target.name = dataObj[0][1];
			  	this.value = target.name;
	  		}
	  	}else if(this.pageKeySon == "4"){	  		
	  		//记录老的值,跟新的值比对
	  		oldData.push(dataObj[0]);
	  		console.log(oldData,"oldData");
	  		
	  		oldData.filter( (item, index) => {
	  			console.log(item,"item")
	  			console.log(index,"index")
	  			console.log(target.name,"target.name")
	  			console.log(item[1].name == target.name)
	      	if (item[1].name == target.name) {
	      		window.alert("名称重复!");
	      		target.address = "";
		  			target.age = "";
		  			target.allprice = "";
		  			target.company = "";
		  			target.day = "";
		  			target.name = "在此输入信息...";
		  			target.key = 5;
		  			target.openingdoctor = "";
		  			target.openingtime = "";
		  			target.price = "";
		  			target.wrong = "";
		  			this.value = target.name;
	      	}else{
	      		target.price = dataObj[0][2];
			  		target.name = dataObj[0][1];
			  		this.value = target.name;
	      	}
	      });
	  	}else{
	  		target.price = dataObj[0][2];
	  		target.name = dataObj[0][1];
	  		this.value = target.name;
	  	};
    },
    edit () {
      this.editable = true;
      this.value = "";
      this.$nextTick( (x) => {   //正确写法
//				console.log(this.$refs.firstInput,"input聚焦的目标")
        this.$refs.firstInput.focus();
      });
      let inframTable = document.querySelector(".inframTable");
      if(this.text != "在此输入信息..."){        
        const dataarr = [...this.dataArr];
        const target = dataarr.find(item => item.key === this.biographyKey)
//      console.log(target)
        if(target.name == "在此输入信息..."){
        	this.value = this.text;
        }else{
        	this.value = target.name;
        }
        inframTable.style.display = "block";
      };
    },    
    myClick (e) {
    	let inframTable = document.querySelector(".inframTable");
    	let trArr = $(".inframTable").find("tbody").find("tr");
    	//获取内层选中数据
      let dataObj = trArr.map( (index, item) => {
      	let dataobj = {};
      	if ($(item).attr("class").indexOf("active") != -1) {
      		let tdArr = $(item).children();
      		dataobj = tdArr.map( (index, item) => {
      			return dataobj[index] = $(item).text()
      		});
      	};
				return dataobj;
      });
      //处理空数据
      dataObj = dataObj.filter( (index, item) => {
      	return Object.keys(item).length !== 0
      });
//    console.log(dataObj, "dataObj");
      //改变外层数据值
//    let dataarr = [...this.dataPriceArr];
      const dataarr = [...this.dataArr];
//	  	console.log(dataarr,"dataarr")
	  	const target = dataarr.find(item => item.key === this.biographyKey) 
//	  	const target = dataarr.find(item => item.key === 0)    	
	  	target.price = dataObj[0][2];
	  	target.name = dataObj[0][1];
	  	this.value = target.name;
	  	inframTable.style.display = "none";
	  	if(this.value == ""){
				this.value = "在此输入信息...";
			}else{
//				console.log(this.biographyKey, "传的Key值")
				keyArr.push(this.biographyKey);
				//初始没有新的一行的添加
				let keyValue = this.dataArr[this.dataArr.length - 1].key;
				if(keyArr.length == 1){
					this.$emit('handleAddSon');
				}else{
					//如果点击的是数据的最后一项添加
					if(this.biographyKey == keyValue){
						this.$emit('handleAddSon');
					};
				};
			};
			if(this.pageKeySon == "2"){
				//获取所有兄弟集合
				let brotherAggregate = this.$parent.$parent.$children;
//				console.log(brotherAggregate,"目标节点brotherAggregate")
				//找到目标元素
				let targetNode = brotherAggregate[2].$children[0];	
				//赋值聚焦
//				console.log(targetNode,"目标节点")
				let targetValue = targetNode.$el;
				targetValue.value = "1";
				targetNode.focus();
			}else if(this.pageKeySon == "3"){
				//获取所有兄弟集合
				let brotherAggregate = this.$parent.$parent.$children;
//				console.log(brotherAggregate,"目标节点brotherAggregate")
				//找到目标元素
				let targetNode = brotherAggregate[4].$children[0];	
				//赋值聚焦
//				console.log(targetNode,"目标节点")
				let targetValue = targetNode.$el;
				targetValue.value = "1";
				targetNode.focus();
			}else{
				//获取所有兄弟集合
				let brotherAggregate = this.$parent.$parent.$children;
//				console.log(brotherAggregate,"目标节点brotherAggregate")
				//找到目标元素
				let targetNode = brotherAggregate[2].$children[0];	
				//赋值聚焦
//				console.log(targetNode,"目标节点")
				let targetValue = targetNode.$el;
				targetValue.value = "1";
				targetNode.focus();
			}
			inframTable.removeEventListener("click", this.myClick);
   },
   changeTable(key) {
   		let inframTable = document.querySelector(".inframTable");
// 		console.log(key,'key')
   		switch(this.biographyKey){
				case 0:
					inframTable.style.top = key + 33 * 0 + "px";
					break;
				case 1:
					inframTable.style.top = key + 33 * 1 + "px";
					break;
				case 2:
					inframTable.style.top = key + 33 * 2 + "px";
					break;
				case 3:
					inframTable.style.top = key + 33 * 3 + "px";
					break;
				case 4:
					inframTable.style.top = key + 33 * 4 + "px";
					break;
				case 5:
					inframTable.style.top = key + 33 * 5 + "px";
					break;
				default:
					inframTable.style.top = key + 33 * 6 + "px";
					break;
			}
   }
  },
//watch: {
//  // 监测路由变化,只要变化了就调用获取路由参数方法将数据存储本组件即可
//    '$route': 'handleChange'
//	},
	created() {   
//		this.handleChange();
		this.event = new CustomEvent('myEvent', {"detail": 0});
		
//		this.event.initEvent('myEvent', {"value": 0}, true);
	}
};
</script>
<style>
  .ant-input{
    border: 0px;
  }
</style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         